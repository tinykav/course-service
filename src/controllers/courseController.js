const Course = require('../models/Course');
const { getEnrollmentCount } = require('../services/externalServices');

// GET /courses
const getAllCourses = async (req, res) => {
  try {
    const courses = await Course.find().sort({ createdAt: -1 });
    res.json(courses);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// GET /courses/:id
const getCourseById = async (req, res) => {
  try {
    const course = await Course.findById(req.params.id);
    if (!course) return res.status(404).json({ error: 'Course not found' });

    // Call Enrollment Service for live count
    const enrolledCount = await getEnrollmentCount(req.params.id);

    res.json({
      ...course.toObject(),
      enrolled_count:  enrolledCount ?? 'unavailable',
      available_seats: enrolledCount !== null
        ? course.capacity - enrolledCount
        : 'unavailable'
    });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// POST /courses
const createCourse = async (req, res) => {
  const { name, description, capacity, credits } = req.body;
  if (!name || !capacity || !credits) {
    return res.status(400).json({ error: 'name, capacity, and credits are required' });
  }
  try {
    const course = await Course.create({ name, description, capacity, credits });
    res.status(201).json(course);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// PUT /courses/:id
const updateCourse = async (req, res) => {
  const { name, description, credits } = req.body;
  try {
    const course = await Course.findByIdAndUpdate(
      req.params.id,
      { ...(name && { name }), ...(description && { description }), ...(credits && { credits }) },
      { new: true }
    );
    if (!course) return res.status(404).json({ error: 'Course not found' });
    res.json(course);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// PUT /courses/:id/capacity — called by Enrollment Service
const updateCapacity = async (req, res) => {
  const { action } = req.body;
  if (!['increment', 'decrement'].includes(action)) {
    return res.status(400).json({ error: "action must be 'increment' or 'decrement'" });
  }
  try {
    const course = await Course.findById(req.params.id);
    if (!course) return res.status(404).json({ error: 'Course not found' });

    if (action === 'decrement') {
      const enrolledCount = await getEnrollmentCount(req.params.id);
      const count = enrolledCount ?? course.capacity - 1;
      if (count >= course.capacity) {
        return res.status(400).json({ error: 'Course is full — no available capacity' });
      }
    }

    course.capacity += action === 'increment' ? 1 : -1;
    await course.save();
    res.json(course);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

module.exports = { getAllCourses, getCourseById, createCourse, updateCourse, updateCapacity };
